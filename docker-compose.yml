---
version: '3.8'
services:

  bot: &emlyon_base
    image: lucmichalski/emlyon-telegram-bot:latest
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
    - db-data:/opt/em-lyon/store 

  crawler:
    <<: *emlyon_base
    volumes:
    - em-data:/opt/em-lyon/data
    - em-cache:/opt/em-lyon/cache
    command: ["emlyon-telegram-qa", "crawl", "--data-dir", "/opt/em-lyon/data", "--cache-dir", "/opt/em-lyon/cache"]

  telegram:
    <<: *emlyon_base
    command: ["emlyon-telegram-qa", "chatbot"]

  train:
    build:
      context: .docker/haystack-train
      dockerfile: Dockerfile
    networks:
    - internal
    volumes:
    - em-data:/opt/em-lyon/data
    depends_on:
    - elastic
    - tika
    command: ["python3", "train.py"]

  elastic:
    image: elasticsearch:7.6.2
    container_name: ${NAMESPACE}-elastic
    networks:
    - internal
    environment:
    - discovery.type=single-node
    volumes:
    - es-data:/usr/share/elasticsearch/data
    ulimits:
      nproc: 65535
      nofile:
         soft: 65535
         hard: 65535
      memlock:
        soft: -1
        hard: -1
    restart: unless-stopped

  tika:
    image: lucmichalski/apachae-tika:alpine3.12-1.24.1
    container_name: ${NAMESPACE}-tika
    build:
      context: .docker/alpine-tika
      dockerfile: Dockerfile
    networks:
    - internal
    volumes:
    - tika-data:/var/tika
    restart: unless-stopped

networks:
  internal:
    driver: bridge

volumes:
  em-data:
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/shared/data/emlyon
  em-cache:
  db-data:
  es-data:
  tika-data:


